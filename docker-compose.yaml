version: '3.7'
volumes:
 db-data:
   driver: local
 mongo-volume:
   driver: local

services:
        #  keycloak:
        #    image: jboss/keycloak:latest
        #    environment:
        #      - KEYCLOAK_USER=admin
        #      - KEYCLOAK_PASSWORD=admin
        #      - KEYCLOAK_IMPORT=/tmp/realm.json
        #      - DB_DATABASE=qa-portal
        #      - DB_USER=postgres
        #      - DB_PASSWORD=postgres
        #      - PROXY_ADDRESS_FORWARDING=true
        #    volumes:
        #      - type: bind
        #        source: ./qa-portal-infra/keycloak/qa-portal-realm.json
        #        target: /tmp/realm.json
        #    depends_on:
        #      - postgres
  postgres:
    image: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=qa-portal
    volumes: 
      - db-data:/var/lib/postgresql/data
    ports:
      - 5432:5432
  mongo:
    image: mongo
    ports:
      - "27017:27017"
    volumes:
    - ./mongo-volume:/data/db
  portal-core:
    image: deployment:5000/portal-core:build-${BUILD_NUMBER}
    build: ./qa-portal-angular
    #    depends_on:
            #      - keycloak
            #      - core-api
            #      - user-api
            #      - self-reflection-api
            #      - course-api
            #      - cv-api
        #      - feedback-api
        #      - question-api
           #   ports:
        #      - target: 80
        #        published: 80
  cv-api:
    image: deployment:5000/cv-api:build-${BUILD_NUMBER}
    build:
      context: ./qa-portal-services
      args: 
        - PROJECT=cv-api
    depends_on: 
      - mongo 
      - postgres
  form-api:
    image: deployment:5000/form-api:build-${BUILD_NUMBER}
    build:
      context: ./qa-portal-services
      args: 
        - PROJECT=form-api
    depends_on: 
      - postgres
  self-reflection-api:
    image: deployment:5000/self-reflection-api:build-${BUILD_NUMBER}
    build:
      context: ./qa-portal-services
      args: 
        - PROJECT=self-reflection-api
    depends_on: 
      - postgres
  feedback-api:
    image: deployment:5000/feedback-api:build-${BUILD_NUMBER}
    build:
      context: ./qa-portal-services
      args: 
        - PROJECT=feedback-api
    depends_on: 
      - postgres
  cohort-api:
    image: deployment:5000/cohort-api:build-${BUILD_NUMBER}
    build:
      context: ./qa-portal-services
      args: 
        - PROJECT=cohort-api
    depends_on: 
      - postgres
  portal-application-api:
    image: deployment:5000/portal-application-api:build-${BUILD_NUMBER}
    build:
      context: ./qa-portal-services
      args: 
        - PROJECT=portal-application-api
    depends_on: 
      - postgres
